{% extends "admin/base.html" %}

{% block page_title %}{{ 'New Stock-In' if order_type == 'stock_in' else 'New Stock-Out' }}{% endblock %}

{% block admin_content %}
<div class="max-w-4xl mx-auto space-y-6">
    <!-- Header -->
    <div class="flex items-center space-x-4">
        <a href="{{ url_for('admin.stock_in') if order_type == 'stock_in' else url_for('admin.stock_out') }}"
            class="text-gray-500 hover:text-gray-700">
            ‚Üê Back
        </a>
        <h2 class="text-xl font-semibold text-gray-900">
            {{ 'Create Stock-In Order' if order_type == 'stock_in' else 'Create Stock-Out Order' }}
        </h2>
    </div>

    <form action="{{ url_for('admin.save_stock_order') }}" method="POST" id="stockOrderForm">
        <input type="hidden" name="order_type" value="{{ order_type }}">

        <!-- Order Info -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <h3 class="font-medium text-gray-900 mb-4">Order Information</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Reference (auto-generated)</label>
                    <input type="text" name="reference" placeholder="Leave empty for auto-generate"
                        class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                    <input type="text" name="notes" placeholder="Optional notes"
                        class="w-full px-3 py-2 border rounded-lg">
                </div>
            </div>
        </div>

        <!-- Product Search -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <h3 class="font-medium text-gray-900 mb-4">Add Products</h3>
            <div class="flex space-x-4">
                <div class="flex-1">
                    <input type="text" id="productSearch" placeholder="Search products by name or set..."
                        class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                </div>
            </div>

            <!-- Search Results -->
            <div id="searchResults" class="mt-4 border rounded-lg hidden max-h-64 overflow-y-auto">
                <!-- Results will be populated by JavaScript -->
            </div>
        </div>

        <!-- Selected Items -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <h3 class="font-medium text-gray-900 mb-4">
                Selected Items
                <span id="itemCount" class="text-gray-500 font-normal">(0 items)</span>
            </h3>

            <table class="w-full" id="selectedItemsTable">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Product</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Condition</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Quantity</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">
                            {{ 'Cost' if order_type == 'stock_in' else 'Reason' }}
                        </th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Action</th>
                    </tr>
                </thead>
                <tbody id="selectedItems" class="divide-y divide-gray-200">
                    <tr id="emptyRow">
                        <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                            No items added. Use the search above to find products.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Submit -->
        <div class="flex justify-end space-x-4">
            <a href="{{ url_for('admin.stock_in') if order_type == 'stock_in' else url_for('admin.stock_out') }}"
                class="px-6 py-3 border rounded-lg hover:bg-gray-50">
                Cancel
            </a>
            <button type="submit" id="submitBtn" disabled
                class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed">
                {{ 'Create Stock-In Order' if order_type == 'stock_in' else 'Create Stock-Out Order' }}
            </button>
        </div>
    </form>
</div>

<!-- Products Data -->
<script>
    const products = {{ products | tojson | safe }};
    const orderType = '{{ order_type }}';
    let selectedItems = [];
    let itemCounter = 0;

    // Search functionality
    const searchInput = document.getElementById('productSearch');
    const searchResults = document.getElementById('searchResults');

    searchInput.addEventListener('input', function () {
        const query = this.value.toLowerCase().trim();

        if (query.length < 2) {
            searchResults.classList.add('hidden');
            return;
        }

        const matches = products.filter(p =>
            p.name.toLowerCase().includes(query) ||
            (p.set_name && p.set_name.toLowerCase().includes(query))
        ).slice(0, 20);

        if (matches.length === 0) {
            searchResults.innerHTML = '<div class="p-4 text-gray-500">No products found</div>';
        } else {
            searchResults.innerHTML = matches.map(p => `
            <div class="p-3 hover:bg-gray-50 cursor-pointer flex justify-between items-center border-b" 
                 onclick="addProduct(${p.id}, '${escapeHtml(p.name)}', '${escapeHtml(p.set_name || '')}')">
                <div>
                    <p class="font-medium text-gray-900">${escapeHtml(p.name)}</p>
                    <p class="text-sm text-gray-500">${escapeHtml(p.set_name || 'No set')}</p>
                </div>
                <button type="button" class="text-indigo-600 hover:text-indigo-800 text-sm font-medium">
                    + Add
                </button>
            </div>
        `).join('');
        }

        searchResults.classList.remove('hidden');
    });

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function addProduct(productId, name, setName) {
        itemCounter++;
        const itemId = 'item_' + itemCounter;

        // Hide empty row
        document.getElementById('emptyRow').style.display = 'none';

        const tbody = document.getElementById('selectedItems');
        const row = document.createElement('tr');
        row.id = itemId;
        row.innerHTML = `
        <td class="px-4 py-3">
            <p class="font-medium text-gray-900">${escapeHtml(name)}</p>
            <p class="text-sm text-gray-500">${escapeHtml(setName)}</p>
            <input type="hidden" name="product_ids[]" value="${productId}">
        </td>
        <td class="px-4 py-3">
            <select name="conditions[]" class="px-2 py-1 border rounded text-sm">
                <option value="NM">Near Mint (NM)</option>
                <option value="EX">Excellent (EX)</option>
                <option value="VG">Very Good (VG)</option>
                <option value="G">Good (G)</option>
                <option value="PL">Played (PL)</option>
            </select>
        </td>
        <td class="px-4 py-3">
            <input type="number" name="quantities[]" value="1" min="1" 
                   class="w-20 px-2 py-1 border rounded text-center" onchange="updateCount()">
        </td>
        <td class="px-4 py-3">
            ${orderType === 'stock_in' ?
                '<input type="number" name="costs[]" value="0" step="0.01" class="w-24 px-2 py-1 border rounded">' :
                '<select name="reasons[]" class="px-2 py-1 border rounded text-sm"><option value="sold">Sold</option><option value="damaged">Damaged</option><option value="returned">Returned</option><option value="other">Other</option></select>'
            }
        </td>
        <td class="px-4 py-3">
            <button type="button" onclick="removeItem('${itemId}')" class="text-red-600 hover:text-red-800 text-sm">
                Remove
            </button>
        </td>
    `;
        tbody.appendChild(row);

        selectedItems.push({ id: itemId, productId, name });
        updateCount();

        // Clear search
        searchInput.value = '';
        searchResults.classList.add('hidden');
    }

    function removeItem(itemId) {
        const row = document.getElementById(itemId);
        if (row) row.remove();

        selectedItems = selectedItems.filter(item => item.id !== itemId);
        updateCount();

        if (selectedItems.length === 0) {
            document.getElementById('emptyRow').style.display = '';
        }
    }

    function updateCount() {
        const count = selectedItems.length;
        document.getElementById('itemCount').textContent = `(${count} item${count !== 1 ? 's' : ''})`;
        document.getElementById('submitBtn').disabled = count === 0;
    }

    // Close search results when clicking outside
    document.addEventListener('click', function (e) {
        if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
            searchResults.classList.add('hidden');
        }
    });
</script>
{% endblock %}